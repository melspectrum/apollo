(require 'package)
(setq package-archives '(("gnu" . "https://mirrors.ustc.edu.cn/elpa/gnu/")
                         ("melpa" . "https://mirrors.ustc.edu.cn/elpa/melpa/")
                         ("nongnu" . "https://mirrors.ustc.edu.cn/elpa/nongnu/")))
(package-initialize)

;; packages
;; (use-package zenburn-theme
;;   :ensure t
;;   :config
;;   (load-theme 'zenburn t))

(use-package recentf
  :ensure t
  :init
  (setq recentf-max-menu-items 25
        recentf-max-saved-items 100)
  :config
  (recentf-mode +1)
  (run-at-time "15 min" 300 'recentf-save-list)
  ;; :bind
  ;; ("C-c f r" . recentf-open-files)
  )

(use-package doom-themes
  :ensure t
  :custom
  (doom-themes-enable-bold t)
  (doom-themes-enable-italic t)
  :config
  (load-theme 'doom-dark+ t)
)

(use-package lsp-mode
  :ensure t
  :commands (lsp lsp-mode)
  :hook ((c++-mode . lsp-mode)
         (python-mode . lsp-mode)
         )
  :init
  (setq lsp-keymap-prefix "C-c l")
  :config
  (lsp-enable-which-key-integration)
  (setq lsp-enable-diagnostics nil)
  (setq lsp-auto-guess-root t)
)

(use-package whole-line-or-region
  :ensure t
  :config
  (whole-line-or-region-global-mode 1))

(use-package stripspace
  :ensure t
  :hook ((prog-mode . stripspace-local-mode)
         (text-mode . stripspace-local-mode)
         (conf-mode . stripspace-local-mode))
  :custom
  (stripspace-only-if-initially-clean nil)
  (stripspace-restore-column t))

(use-package vertico
  :ensure t
  :init
  (vertico-mode)
  :custom
  ;; (vertico-scroll-margin 0)
  (vertico-count 15)
  (vertico-resize nil)
  (vertico-cycle t)
  :custom-face
  (vertico-current ((t (:background "#005f87" :foreground "#ffffff"))))
  )

(use-package savehist
  :ensure t
  :init
  (savehist-mode))

(use-package emacs
  :custom
  (context-menu-mode t)
  (enable-recursive-minibuffers t)
  (read-extended-command-predicate #'command-completion-default-include-p)
  (minibuffer-prompt-properties
   '(read-only t cursor-intangible t face minibuffer-prompt)))

(use-package consult
  :ensure t
  :bind (("C-x b" . consult-buffer)
         ("C-c s" . consult-line)
         ("C-c g" . consult-goto-line)
         ("C-c f r" . consult-recent-file)
         )
  :config
  (setq consult-ripgrep-command
      "rg --null --line-buffered --color=always --smart-case --no-heading --line-number --max-columns=1000 . -e ARG OPTS")
  (setq consult-ripgrep-line-format "%5l:%2c  %f: %m")
  (setq consult-preview-wrap nil)
  (setq consult-preview-key nil)
  (defun my-consult-buffer-predicate (buffer)
    (not (string-match-p "^\\*scratch\\*\\|^\\*Messages\\*\\|^\\*SomethingElse\\* "
                         (buffer-name buffer))))
  (setq consult-buffer-sources
        `((:name "Buffer"
           :narrow ?b
           :category buffer
           :face consult-buffer
           :history buffer-name-history
           :state ,#'consult--buffer-state
           :default t
           :items (lambda ()
                    (consult--buffer-query
                     :sort 'visibility
                     :exclude '("^ " "^\\*")
                     :predicate #'my-consult-buffer-predicate
                     :as #'buffer-name)))))
  (setq consult-project-root-function #'projectile-project-root)
  )

(use-package projectile
  :ensure t
  :init
  (projectile-mode +1)
  :bind (:map projectile-mode-map
              ("C-c p f" . projectile-find-file)
              ;;("C-c p p" . projectile-switch-project)
              )
  :custom
  (projectile-completion-system 'default)
  (projectile-indexing-method 'alien)
  (setq projectile-enable-caching t)
  :config
  (define-key projectile-mode-map (kbd "C-c p") nil)
)

(global-set-key (kbd "C-c p s") #'consult-ripgrep)

(use-package embark
  :ensure t
  :after consult
  :init
  (setq prefix-help-command #'embark-prefix-help-command)
  :config
  (add-hook 'embark-collect-mode-hook #'consult-preview-at-point-mode))

(use-package embark-consult
  :ensure t
  :after (embark consult))

(use-package orderless
  :ensure t
  :init
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion)))))

(use-package marginalia
  :ensure t
  :init
  (marginalia-mode))

(use-package doom-modeline
  :ensure t
  :init (doom-modeline-mode 1))

(use-package which-key
  :ensure t
  :config
  (which-key-mode))

;; settings

(add-to-list 'display-buffer-alist
             '("\\*rg\\*"
               . (nil . ((body-function . select-window)))))

(save-place-mode 1)
(global-set-key (kbd "<select>") 'move-end-of-line)
;; (tool-bar-mode 0)
(menu-bar-mode 0)
(if (fboundp 'scroll-bar-mode) (scroll-bar-mode -1))
(show-paren-mode t)
(setq make-backup-files nil)

;;(add-to-list 'auto-mode-alist '("\\.h\\'" . c++-mode))
(setq-default c-basic-offset 2)


(setq treesit-language-source-alist
      '((cpp "https://github.com/tree-sitter/tree-sitter-cpp" "v0.22.0")
        (c "https://github.com/tree-sitter/tree-sitter-c" "v0.23.0")))

(add-to-list 'auto-mode-alist '("\\.\\(cpp\\|cxx\\|cc\\|C\\)\\'" . c++-ts-mode))
(add-to-list 'auto-mode-alist '("\\.\\(hpp\\|hxx\\|hh\\|H\\)\\'" . c++-ts-mode))
(add-to-list 'auto-mode-alist '("\\.h\\'" . c++-ts-mode))

(defun set-c++-ts-indentation ()
  (setq c-ts-mode-indent-offset 2
        tab-width 2
        indent-tabs-mode nil))

(add-hook 'c++-ts-mode-hook #'set-c++-ts-indentation)
;;(global-set-key [f8] (quote set-mark-command))

(setq whitespace-style '(face trailing tabs empty))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(whitespace-tab ((t (:background "red")))))
(global-whitespace-mode 1)

(setq column-number-mode t)
(setq indent-tabs-mode nil)
(setq-default indent-tabs-mode nil)

(setq resize-mini-windows t)
(setq max-mini-window-height 0.4)

(blink-cursor-mode 0)
(setq visible-bell t)
(setq ring-bell-function 'ignore)

(setq scroll-preserve-screen-position t)
(setq scroll-error-top-bottom t)

(global-auto-revert-mode t)
(setq inhibit-startup-screen t)
(setq initial-scratch-message nil)
(setq inhibit-startup-echo-area-message (user-login-name))

(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(package-selected-packages nil))
